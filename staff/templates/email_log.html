{% load cms_tags staticfiles sekizai_tags %}

{% addtoblock "js" %}
    <script>
        $(document).ready(function() {
            
            // If there is an email id, show that email.
            var emailId = getQueryVariable("emailId");
            if (emailId != null && emailId != "") {
                show_email_instance_{{ instance.id }}(emailId);
            } else {
                // Otherwise, there is no email id. Show list of emails.
                show_email_list_{{ instance.id }}();
            }
        });
        
        function show_email_instance_{{ instance.id }}(emailId) {
            clear_page_{{ instance.id }}();
            var jqXHR = fetch_email_instance_{{ instance.id }}(emailId);
            jqXHR.done(function( data, textStatus, jqXHR ) {
                var email = data.email;
                $("#from_email_{{ instance.id }}").html(email.from_email);
                $("#to_email_{{ instance.id }}").html(email.to);
                $("#cc_email_{{ instance.id }}").html(email.cc);
                $("#email_timestamp_{{ instance.id }}").html(email.timestamp);
                $("#email_sent_successfully_{{ instance.id }}").html(email.sent_successfully);
                $("#email_subject_{{ instance.id }}").html(email.subject);
                $("#email_body_{{ instance.id }}").html(email.body);
                $("#email_instance_{{ instance.id }}").show();
            });
            jqXHR.fail(function( jqXHR, textStatus, errorThrown ) {
                if (errorThrown == "FORBIDDEN") {
                    $("#error_list_{{ instance.id }}").append("<li>Forbidden. You do not have authorization to view this page.</li>");
                } else if (errorThrown == "NOT FOUND") {
                    $("#error_list_{{ instance.id }}").append("<li>Not found. This email does not exist on our server.</li>");
                } else {
                    $("#error_list_{{ instance.id }}").append("<li>Internal server error. Please try again later.</li>");
                }
            });
        }

        function show_email_list_{{ instance.id }}() {
            clear_page_{{ instance.id }}();
            var jqXHR = fetch_email_list_{{ instance.id }}();
            jqXHR.done(function( data, textStatus, jqXHR ) {
                var emails = data.emails;
                $("#email_list_{{ instance.id }} tbody").empty();
                for (var i = 0; i < emails.length; i++) {
                    email = emails[i];
                    row = "<tr><td><a href=\"#\" onclick=\"show_email_instance_{{ instance.id }}(" + email.id + ");\" >" + email.from_email + "</a></td>" +
                        "<td>" + email.to + "</td>" +
                        "<td>" + email.subject + "</td>" +
                        "<td>" + email.timestamp + "</td>" +
                        "<td>" + email.sent_successfully + "</td></tr>"
                    $("#email_list_{{ instance.id }} tbody").append(row);
                }
                $("#email_list_{{ instance.id }}").show();
            });
            jqXHR.fail(function( jqXHR, textStatus, errorThrown ) {
                if (errorThrown == "FORBIDDEN") {
                    $("#error_list_{{ instance.id }}").append("<li>Forbidden. You do not have authorization to view this page.</li>");
                } else {
                    $("#error_list_{{ instance.id }}").append("<li>Internal server error. Please try again later.</li>");
                }
            });
        }

        function clear_page_{{ instance.id }}() {
            clear_errors_{{ instance.id }}();
            $("#email_instance_{{ instance.id }}").hide();
            $("#email_list_{{ instance.id }}").hide();
        }
        
        function clear_errors_{{ instance.id }}() {
            $("#error_list_{{ instance.id }}").empty();
        }
        
        function fetch_email_instance_{{ instance.id }}(emailId) {
            var data = {};
            data["emailId"] = emailId;
            var jqXHR = $.ajax({
                type: "GET",
                url: "{% url 'staff:email_instance' %}",
                data: data
            });
            return jqXHR;
        }

        function fetch_email_list_{{ instance.id }}() {
            var jqXHR = $.ajax({
                type: "GET",
                url: "{% url 'staff:email_list' %}"
            });
            return jqXHR;
        }

        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) {
                    return pair[1];
                }
            }
            return (false);
        }
    </script>
{% endaddtoblock %}

<ul id="error_list_{{ instance.id }}" class="text-danger"></ul>

<form id="email_instance_{{ instance.id }}" class="form-horizontal" onsubmit="return false;" style="display: none;">
    {% csrf_token %}
    <div class="form-group">
        <label class="col-sm-2 control-label" for="from_email_{{ instance.id }}">From Email</label>
        <div class="col-sm-4">        
            <p class="form-control-static" id="from_email_{{ instance.id }}"></p>
        </div>
        <label class="col-sm-2 control-label" for="to_email_{{ instance.id }}">To</label>
        <div class="col-sm-4">        
            <p class="form-control-static" id="to_email_{{ instance.id }}"></p>
        </div>
        <label class="col-sm-offset-6 col-sm-2 control-label" for="cc_email_{{ instance.id }}">CC</label>
        <div class="col-sm-4">        
            <p class="form-control-static" id="cc_email_{{ instance.id }}"></p>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label" for="email_timestamp_{{ instance.id }}">Timestamp</label>
        <div class="col-sm-3">        
            <p class="form-control-static" id="email_timestamp_{{ instance.id }}">foo</p>
        </div>
        <label class="col-sm-3 control-label" for="email_sent_successfully_{{ instance.id }}">Sent Successfully</label>
        <div class="col-sm-4">        
            <p class="form-control-static" id="email_sent_successfully_{{ instance.id }}">bar</p>
        </div>
    </div>
    <div class="form-group">
        <label class="col-sm-2 control-label" for="email_subject_{{ instance.id }}">Subject</label>
        <div class="col-sm-10">        
            <p class="form-control-static" id="email_subject_{{ instance.id }}"></p>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label" for="email_body_{{ instance.id }}">Message</label>
        <pre class="form-control-static" id="email_body_{{ instance.id }}"></pre>
    </div>
    <div class="form-group">
        <div class="col-sm-offset-2 col-sm-10">
            <button id="reply_{{ instance.id }}" class="btn btn-primary">Reply</button>
            <button id="list_{{ instance.id }}" class="btn btn-default" onclick="show_email_list_{{ instance.id }}();">Email List</button>
        </div>
    </div>
</form>

<div id="email_list_{{ instance.id }}" class="table-responsive" style="display: none;">
    <table class="table table-striped table-condensed">
        <thead>
            <tr>
                <th>From Email</th>
                <th>To</th>
                <th>Subject</th>
                <th>Timestamp</th>
                <th>Sent Successfully</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>